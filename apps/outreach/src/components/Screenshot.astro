---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { useTranslations } from '@/i18n';

interface Props {
  alt: string;
  name: string;
}

const { altLanguage, resolvedLanguage } = useTranslations(Astro.url);

const { alt, name } = Astro.props;
const images = import.meta.glob<ImageMetadata>(`@/assets/screenshots/*.{jpeg,jpg,png,gif}`, {
  import: 'default'
});

let screenshots: { en?: () => Promise<ImageMetadata>; fr?: () => Promise<ImageMetadata> } = {};
for (const path in images) {
  const [basename, theme, language] = path.split('/screenshots/').at(-1)?.split('.')!;
  if (!(basename && (theme === 'dark' || theme === 'light') && (language === 'en' || language === 'fr'))) {
    throw new Error(
      `Invalid screenshot path '${path}', expected filename format '*.(dark|light).(en|fr).(jpeg|jpg|png,gif)'`
    );
  } else if (basename === name) {
    screenshots[language] = images[path];
  }
}

let src: ImageMetadata;
if (screenshots[resolvedLanguage]) {
  src = await screenshots[resolvedLanguage]!();
} else if (screenshots[altLanguage]) {
  src = await screenshots[altLanguage]!();
} else {
  throw new Error(`Failed to find screenshot '${name}' from files: ${Object.keys(images).join(', ')}`);
}
---

<Image src={src} alt={alt} />
