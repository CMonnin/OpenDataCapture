// @ts-nocheck

import img_1 from './1.webp';
import img_1_1 from './1-1.webp';
import img_1_2 from './1-2.webp';
import img_1_3 from './1-3.webp';
import img_1_4 from './1-4.webp';
import img_1_5 from './1-5.webp';
import img_2 from './2.webp';
import img_2_1 from './2-1.webp';
import img_2_2 from './2-2.webp';
import img_2_3 from './2-3.webp';
import img_2_4 from './2-4.webp';
import img_2_5 from './2-5.webp';
import img_3 from './3.webp';
import img_3_1 from './3-1.webp';
import img_3_2 from './3-2.webp';
import img_3_3 from './3-3.webp';
import img_3_4 from './3-4.webp';
import img_3_5 from './3-5.webp';
import img_4 from './4.webp';
import img_4_1 from './4-1.webp';
import img_4_2 from './4-2.webp';
import img_4_3 from './4-3.webp';
import img_4_4 from './4-4.webp';
import img_4_5 from './4-5.webp';
import img_5 from './5.webp';
import img_5_1 from './5-1.webp';
import img_5_2 from './5-2.webp';
import img_5_3 from './5-3.webp';
import img_5_4 from './5-4.webp';
import img_5_5 from './5-5.webp';
import img_6 from './6.webp';
import img_6_1 from './6-1.webp';
import img_6_2 from './6-2.webp';
import img_6_3 from './6-3.webp';
import img_6_4 from './6-4.webp';
import img_6_5 from './6-5.webp';
import img_7 from './7.webp';
import img_7_1 from './7-1.webp';
import img_7_2 from './7-2.webp';
import img_7_3 from './7-3.webp';
import img_7_4 from './7-4.webp';
import img_7_5 from './7-5.webp';
import img_8 from './8.webp';
import img_8_1 from './8-1.webp';
import img_8_2 from './8-2.webp';
import img_8_3 from './8-3.webp';
import img_8_4 from './8-4.webp';
import img_8_5 from './8-5.webp';
import img_9 from './9.webp';
import img_9_1 from './9-1.webp';
import img_9_2 from './9-2.webp';
import img_9_3 from './9-3.webp';
import img_9_4 from './9-4.webp';
import img_9_5 from './9-5.webp';
import img_10 from './10.webp';
import img_10_1 from './10-1.webp';
import img_10_2 from './10-2.webp';
import img_10_3 from './10-3.webp';
import img_10_4 from './10-4.webp';
import img_10_5 from './10-5.webp';
import img_11 from './11.webp';
import img_11_1 from './11-1.webp';
import img_11_2 from './11-2.webp';
import img_11_3 from './11-3.webp';
import img_11_4 from './11-4.webp';
import img_11_5 from './11-5.webp';
import img_12 from './12.webp';
import img_12_1 from './12-1.webp';
import img_12_2 from './12-2.webp';
import img_12_3 from './12-3.webp';
import img_12_4 from './12-4.webp';
import img_12_5 from './12-5.webp';
import img_13 from './13.webp';
import img_13_1 from './13-1.webp';
import img_13_2 from './13-2.webp';
import img_13_3 from './13-3.webp';
import img_13_4 from './13-4.webp';
import img_13_5 from './13-5.webp';
import img_14 from './14.webp';
import img_14_1 from './14-1.webp';
import img_14_2 from './14-2.webp';
import img_14_3 from './14-3.webp';
import img_14_4 from './14-4.webp';
import img_14_5 from './14-5.webp';
import img_15 from './15.webp';
import img_15_1 from './15-1.webp';
import img_15_2 from './15-2.webp';
import img_15_3 from './15-3.webp';
import img_15_4 from './15-4.webp';
import img_15_5 from './15-5.webp';
import img_16 from './16.webp';
import img_16_1 from './16-1.webp';
import img_16_2 from './16-2.webp';
import img_16_3 from './16-3.webp';
import img_16_4 from './16-4.webp';
import img_16_5 from './16-5.webp';
import img_17 from './17.webp';
import img_17_1 from './17-1.webp';
import img_17_2 from './17-2.webp';
import img_17_3 from './17-3.webp';
import img_17_4 from './17-4.webp';
import img_17_5 from './17-5.webp';
import img_18 from './18.webp';
import img_18_1 from './18-1.webp';
import img_18_2 from './18-2.webp';
import img_18_3 from './18-3.webp';
import img_18_4 from './18-4.webp';
import img_18_5 from './18-5.webp';
import img_19 from './19.webp';
import img_19_1 from './19-1.webp';
import img_19_2 from './19-2.webp';
import img_19_3 from './19-3.webp';
import img_19_4 from './19-4.webp';
import img_19_5 from './19-5.webp';
import img_20 from './20.webp';
import img_20_1 from './20-1.webp';
import img_20_2 from './20-2.webp';
import img_20_3 from './20-3.webp';
import img_20_4 from './20-4.webp';
import img_20_5 from './20-5.webp';
import img_21 from './21.webp';
import img_21_1 from './21-1.webp';
import img_21_2 from './21-2.webp';
import img_21_3 from './21-3.webp';
import img_21_4 from './21-4.webp';
import img_21_5 from './21-5.webp';
import img_22 from './22.webp';
import img_22_1 from './22-1.webp';
import img_22_2 from './22-2.webp';
import img_22_3 from './22-3.webp';
import img_22_4 from './22-4.webp';
import img_22_5 from './22-5.webp';
import img_23 from './23.webp';
import img_23_1 from './23-1.webp';
import img_23_2 from './23-2.webp';
import img_23_3 from './23-3.webp';
import img_23_4 from './23-4.webp';
import img_23_5 from './23-5.webp';
import img_24 from './24.webp';
import img_24_1 from './24-1.webp';
import img_24_2 from './24-2.webp';
import img_24_3 from './24-3.webp';
import img_24_4 from './24-4.webp';
import img_24_5 from './24-5.webp';
import img_25 from './25.webp';
import img_25_1 from './25-1.webp';
import img_25_2 from './25-2.webp';
import img_25_3 from './25-3.webp';
import img_25_4 from './25-4.webp';
import img_25_5 from './25-5.webp';
import img_26 from './26.webp';
import img_26_1 from './26-1.webp';
import img_26_2 from './26-2.webp';
import img_26_3 from './26-3.webp';
import img_26_4 from './26-4.webp';
import img_26_5 from './26-5.webp';
import img_27 from './27.webp';
import img_27_1 from './27-1.webp';
import img_27_2 from './27-2.webp';
import img_27_3 from './27-3.webp';
import img_27_4 from './27-4.webp';
import img_27_5 from './27-5.webp';
import img_28 from './28.webp';
import img_28_1 from './28-1.webp';
import img_28_2 from './28-2.webp';
import img_28_3 from './28-3.webp';
import img_28_4 from './28-4.webp';
import img_28_5 from './28-5.webp';
import img_29 from './29.webp';
import img_29_1 from './29-1.webp';
import img_29_2 from './29-2.webp';
import img_29_3 from './29-3.webp';
import img_29_4 from './29-4.webp';
import img_29_5 from './29-5.webp';
import img_30 from './30.webp';
import img_30_1 from './30-1.webp';
import img_30_2 from './30-2.webp';
import img_30_3 from './30-3.webp';
import img_30_4 from './30-4.webp';
import img_30_5 from './30-5.webp';
import img_31 from './31.webp';
import img_31_1 from './31-1.webp';
import img_31_2 from './31-2.webp';
import img_31_3 from './31-3.webp';
import img_31_4 from './31-4.webp';
import img_31_5 from './31-5.webp';
import img_32 from './32.webp';
import img_32_1 from './32-1.webp';
import img_32_2 from './32-2.webp';
import img_32_3 from './32-3.webp';
import img_32_4 from './32-4.webp';
import img_32_5 from './32-5.webp';
import img_33 from './33.webp';
import img_33_1 from './33-1.webp';
import img_33_2 from './33-2.webp';
import img_33_3 from './33-3.webp';
import img_33_4 from './33-4.webp';
import img_33_5 from './33-5.webp';
import img_34 from './34.webp';
import img_34_1 from './34-1.webp';
import img_34_2 from './34-2.webp';
import img_34_3 from './34-3.webp';
import img_34_4 from './34-4.webp';
import img_34_5 from './34-5.webp';
import img_35 from './35.webp';
import img_35_1 from './35-1.webp';
import img_35_2 from './35-2.webp';
import img_35_3 from './35-3.webp';
import img_35_4 from './35-4.webp';
import img_35_5 from './35-5.webp';
import img_36 from './36.webp';
import img_36_1 from './36-1.webp';
import img_36_2 from './36-2.webp';
import img_36_3 from './36-3.webp';
import img_36_4 from './36-4.webp';
import img_36_5 from './36-5.webp';
import img_37 from './37.webp';
import img_37_1 from './37-1.webp';
import img_37_2 from './37-2.webp';
import img_37_3 from './37-3.webp';
import img_37_4 from './37-4.webp';
import img_37_5 from './37-5.webp';
import fail from './fail.webp';
import stimImg from './stimImg.webp';
import success from './success.webp';
import white from './white.webp';

const html = `
<div id="content">
  <div id="headText"></div>
  <div id="trialNum"></div>
  <div id="stimDiv" class="slide">
    <img src=${white} name="question" id="question" class="stims" />
    <div style="margin-top: 60px">
      <img
        src=${white}
        name="leftmostStim"
        id="leftmostStim"
        class="stims"
      />
      <img
        src=${white}
        name="leftStim"
        id="leftStim"
        class="stims"
      />
      <img
        src=${white}
        name="centerStim"
        id="centerStim"
        class="stims"
      />
      <img
        src=${white}
        name="rightStim"
        id="rightStim"
        class="stims"
      />
      <img
        src=${white}
        name="rightmostStim"
        id="rightmostStim"
        class="stims"
      />
      <br />
    </div>
  </div>
  <div id="inst2" class="slide inst_div">
    <span id="inst2text"></span>
  </div>
  <div id="warn" class="slide inst_div">
    <span id="warning_text"></span>
  </div>
  <div id="correct" class="slide">
    <img src=${success} class="smiley" /><span id="correct_text"></span>
  </div>
  <div id="incorrect" class="slide">
    <img src=${fail} class="smiley" /><span id="incorrect_text"></span>
  </div>
  <div id="empty" class="slide"></div>
</div>
<form id="form" action="/run" method="POST">
  <input type="hidden" id="data" name="data" />
  <input type="hidden" id="score" name="score" value="0" />
</form>
</body>
`;

/**
 * Wrapper for the legacy ManyBrains code. This must be a function to avoid accessing
 * browser APIs on the server.
 * @param {(data: { results: any[], score: number  }) => void} done
 */
export async function render(done) {
  const { default: $ } = await import('/runtime/v1/jquery@1.12.4/index.js');
  const {
    $$$,
    chain,
    clearChain,
    disableElasticScrolling,
    disableKeyboard,
    disableTouch,
    getKeyboardInput,
    getTouchInput,
    preload,
    showSlide
  } = await import('/runtime/v1/zen@0.0.2/index.js');

  /**
   *
   * @param {string} type
   * @param {string} keyCode
   */
  function simulateKeyEvent(type, keyCode) {
    const customEvent = new KeyboardEvent(type, {
      altKey: false,
      bubbles: true,
      cancelable: true,
      charCode: 0,
      ctrlKey: false,
      keyCode,
      metaKey: false,
      shiftKey: false,
      view: window
    });
    document.dispatchEvent(customEvent);
  }

  document.body.innerHTML = html;

  // first, get whether this is a mobile device
  const withTouch = 0;

  // all the text that is ever displayed to the user
  const text = withTouch
    ? {
        correct: 'That is correct. Please tap the screen to continue. ',
        incorrect: 'That is incorrect. Please tap the screen to see the pictures again. ',
        inst2:
          'That concludes the practice portion of this test. ' +
          '<br><br>From here on, the test items will get more difficult. ' +
          '<br>You should always choose the image piece that best completes the pattern. ' +
          'There is only one correct answer for each test item. ' +
          'You have as long as you like to choose your response, but please try to answer as quickly as possible without sacrificing accuracy. ' +
          "If you don't know the answer, take your best guess. " +
          `<br><br><img src=${stimImg} id='stimImg' class='insts'/>` +
          '<br>Please tap the screen to start. ',
        // remove the memorize part
        instPrac: '<h3>Practice: </h3>Tap the image piece that best completes the pattern. ',
        ofNumPracTestStims: ' of 2',
        ofNumTestStims: ' of 35',
        troubleshooting:
          'If you are having trouble responding, make sure you are using a modern browser. ' +
          "If you are not certain, use your mobile device's default browser. " +
          '<br><br>Please lightly tap the image to select. ' +
          '<br><br>If this problem persists, please contact us and let know of your ' +
          "mobile device's name and software version. " +
          '<br><br>This message will not appear again. Please tap your screen to continue. '
      }
    : {
        correct: 'That is correct. <br>Click <b>HERE</b> to continue. ',
        incorrect: 'That is incorrect. <br>Click <b>HERE</b> to see the pictures again. ',
        inst2:
          'That concludes the practice portion of this test. ' +
          '<br><br>From here on, the test items will get more difficult. ' +
          '<br>You should always choose the image piece that best completes the pattern. ' +
          'There is only one correct answer for each test item. ' +
          'You have as long as you like to choose your response, but please try to answer as quickly as possible without sacrificing accuracy. ' +
          "If you don't know the answer, take your best guess. " +
          '<br><br>Click <b>HERE</b> to start. ',
        instPrac: '<h3>Practice: </h3>Click on the image below that best completes the pattern. ',
        ofNumPracTestStims: ' of 2',
        ofNumTestStims: ' of 35',
        troubleshooting:
          'You reached the time limit.<br>' +
          'Click <b>HERE</b> to continue.<br><br><br> ' +
          'If you are having trouble responding, try using ' +
          'the numbers 1-5 on your keyboard.<br> ' +
          'Click <b>HERE</b> to try that.<br><br> ' +
          'If you are not able to use a keyboard ' +
          '(because you are using a mobile device, for example), ' +
          'make sure that you are clicking <i>directly</i> on ' +
          'one of the images (at the <i>bottom</i> of the page) ' +
          'that has a number below it.<br> ' +
          'Click <b>HERE</b> to try that.<br><br> ' +
          'If none of these strategies work, ' +
          'we would be happy to hear from you ' +
          '(email: testmybrain@gmail.com; it is helpful to know ' +
          'which computer/device and browser you are using).'
      };

  // config object for all configuration parameters
  const config = {
    ITIDuration: 300,
    respDuration: 20000,
    stimDuration: 1000
  };

  // experiment object holds all the information necessary for the experiment, records data
  const experiment = {
    // blankImg is the generic name we use for the inter-stimulus non-fixation cross image
    blankImg: white,
    centerStim: null,

    //where correct responses go and use answer sheet, remove 0
    correctResponses: [
      3, 1, 0, 2, 1, 4, 3, 1, 3, 3, 4, 4, 1, 5, 1, 2, 3, 2, 5, 4, 2, 1, 2, 5, 3, 1, 3, 4, 3, 5, 4, 5, 4, 1, 5, 3, 3, 1
    ],

    leftStim: null,
    leftmostStim: null,
    // array to preload resources
    preloadArr: [
      img_1,
      img_2,
      img_5,
      img_15,
      img_6,
      img_3,
      img_8,
      img_7,
      img_19,
      img_18,
      img_4,
      img_9,
      img_13,
      img_21,
      img_25,
      img_10,
      img_17,
      img_12,
      img_22,
      img_14,
      img_16,
      img_26,
      img_24,
      img_29,
      img_20,
      img_30,
      img_11,
      img_31,
      img_28,
      img_32,
      img_23,
      img_34,
      img_27,
      img_37,
      img_35,
      img_36,
      img_33,
      img_1_1,
      img_2_1,
      img_5_1,
      img_15_1,
      img_6_1,
      img_3_1,
      img_8_1,
      img_7_1,
      img_19_1,
      img_18_1,
      img_4_1,
      img_9_1,
      img_13_1,
      img_21_1,
      img_25_1,
      img_10_1,
      img_17_1,
      img_12_1,
      img_22_1,
      img_14_1,
      img_16_1,
      img_26_1,
      img_24_1,
      img_29_1,
      img_20_1,
      img_30_1,
      img_11_1,
      img_31_1,
      img_28_1,
      img_32_1,
      img_23_1,
      img_34_1,
      img_27_1,
      img_37_1,
      img_35_1,
      img_36_1,
      img_33_1,
      img_1_2,
      img_2_2,
      img_5_2,
      img_15_2,
      img_6_2,
      img_3_2,
      img_8_2,
      img_7_2,
      img_19_2,
      img_18_2,
      img_4_2,
      img_9_2,
      img_13_2,
      img_21_2,
      img_25_2,
      img_10_2,
      img_17_2,
      img_12_2,
      img_22_2,
      img_14_2,
      img_16_2,
      img_26_2,
      img_24_2,
      img_29_2,
      img_20_2,
      img_30_2,
      img_11_2,
      img_31_2,
      img_28_2,
      img_32_2,
      img_23_2,
      img_34_2,
      img_27_2,
      img_37_2,
      img_35_2,
      img_36_2,
      img_33_2,
      img_1_3,
      img_2_3,
      img_5_3,
      img_15_3,
      img_6_3,
      img_3_3,
      img_8_3,
      img_7_3,
      img_19_3,
      img_18_3,
      img_4_3,
      img_9_3,
      img_13_3,
      img_21_3,
      img_25_3,
      img_10_3,
      img_17_3,
      img_12_3,
      img_22_3,
      img_14_3,
      img_16_3,
      img_26_3,
      img_24_3,
      img_29_3,
      img_20_3,
      img_30_3,
      img_11_3,
      img_31_3,
      img_28_3,
      img_32_3,
      img_23_3,
      img_34_3,
      img_27_3,
      img_37_3,
      img_35_3,
      img_36_3,
      img_33_3,
      img_1_4,
      img_2_4,
      img_5_4,
      img_15_4,
      img_6_4,
      img_3_4,
      img_8_4,
      img_7_4,
      img_19_4,
      img_18_4,
      img_4_4,
      img_9_4,
      img_13_4,
      img_21_4,
      img_25_4,
      img_10_4,
      img_17_4,
      img_12_4,
      img_22_4,
      img_14_4,
      img_16_4,
      img_26_4,
      img_24_4,
      img_29_4,
      img_20_4,
      img_30_4,
      img_11_4,
      img_31_4,
      img_28_4,
      img_32_4,
      img_23_4,
      img_34_4,
      img_27_4,
      img_37_4,
      img_35_4,
      img_36_4,
      img_33_4,
      img_1_5,
      img_2_5,
      img_5_5,
      img_15_5,
      img_6_5,
      img_3_5,
      img_8_5,
      img_7_5,
      img_19_5,
      img_18_5,
      img_4_5,
      img_9_5,
      img_13_5,
      img_21_5,
      img_25_5,
      img_10_5,
      img_17_5,
      img_12_5,
      img_22_5,
      img_14_5,
      img_16_5,
      img_26_5,
      img_24_5,
      img_29_5,
      img_20_5,
      img_30_5,
      img_11_5,
      img_31_5,
      img_28_5,
      img_32_5,
      img_23_5,
      img_34_5,
      img_27_5,
      img_37_5,
      img_35_5,
      img_36_5,
      img_33_5
    ],
    question: null,
    // results will hold all of the results that get submitted at the end of the experiment
    results: [],
    rightStim: null,

    // the simuli
    rightmostStim: null,
    // ALL SET
    // implement 5 arrays
    stims: [
      [
        img_1,
        img_2,
        '',
        img_5,
        img_15,
        img_6,
        img_3,
        img_8,
        img_7,
        img_19,
        img_18,
        img_4,
        img_9,
        img_13,
        img_21,
        img_25,
        img_10,
        img_17,
        img_12,
        img_22,
        img_14,
        img_16,
        img_26,
        img_24,
        img_29,
        img_20,
        img_30,
        img_11,
        img_31,
        img_28,
        img_32,
        img_23,
        img_34,
        img_27,
        img_37,
        img_35,
        img_36,
        img_33
      ],
      [
        img_1_1,
        img_2_1,
        '',
        img_5_1,
        img_15_1,
        img_6_1,
        img_3_1,
        img_8_1,
        img_7_1,
        img_19_1,
        img_18_1,
        img_4_1,
        img_9_1,
        img_13_1,
        img_21_1,
        img_25_1,
        img_10_1,
        img_17_1,
        img_12_1,
        img_22_1,
        img_14_1,
        img_16_1,
        img_26_1,
        img_24_1,
        img_29_1,
        img_20_1,
        img_30_1,
        img_11_1,
        img_31_1,
        img_28_1,
        img_32_1,
        img_23_1,
        img_34_1,
        img_27_1,
        img_37_1,
        img_35_1,
        img_36_1,
        img_33_1
      ],
      [
        img_1_2,
        img_2_2,
        '',
        img_5_2,
        img_15_2,
        img_6_2,
        img_3_2,
        img_8_2,
        img_7_2,
        img_19_2,
        img_18_2,
        img_4_2,
        img_9_2,
        img_13_2,
        img_21_2,
        img_25_2,
        img_10_2,
        img_17_2,
        img_12_2,
        img_22_2,
        img_14_2,
        img_16_2,
        img_26_2,
        img_24_2,
        img_29_2,
        img_20_2,
        img_30_2,
        img_11_2,
        img_31_2,
        img_28_2,
        img_32_2,
        img_23_2,
        img_34_2,
        img_27_2,
        img_37_2,
        img_35_2,
        img_36_2,
        img_33_2
      ],
      [
        img_1_3,
        img_2_3,
        '',
        img_5_3,
        img_15_3,
        img_6_3,
        img_3_3,
        img_8_3,
        img_7_3,
        img_19_3,
        img_18_3,
        img_4_3,
        img_9_3,
        img_13_3,
        img_21_3,
        img_25_3,
        img_10_3,
        img_17_3,
        img_12_3,
        img_22_3,
        img_14_3,
        img_16_3,
        img_26_3,
        img_24_3,
        img_29_3,
        img_20_3,
        img_30_3,
        img_11_3,
        img_31_3,
        img_28_3,
        img_32_3,
        img_23_3,
        img_34_3,
        img_27_3,
        img_37_3,
        img_35_3,
        img_36_3,
        img_33_3
      ],
      [
        img_1_4,
        img_2_4,
        '',
        img_5_4,
        img_15_4,
        img_6_4,
        img_3_4,
        img_8_4,
        img_7_4,
        img_19_4,
        img_18_4,
        img_4_4,
        img_9_4,
        img_13_4,
        img_21_4,
        img_25_4,
        img_10_4,
        img_17_4,
        img_12_4,
        img_22_4,
        img_14_4,
        img_16_4,
        img_26_4,
        img_24_4,
        img_29_4,
        img_20_4,
        img_30_4,
        img_11_4,
        img_31_4,
        img_28_4,
        img_32_4,
        img_23_4,
        img_34_4,
        img_27_4,
        img_37_4,
        img_35_4,
        img_36_4,
        img_33_4
      ],
      [
        img_1_5,
        img_2_5,
        '',
        img_5_5,
        img_15_5,
        img_6_5,
        img_3_5,
        img_8_5,
        img_7_5,
        img_19_5,
        img_18_5,
        img_4_5,
        img_9_5,
        img_13_5,
        img_21_5,
        img_25_5,
        img_10_5,
        img_17_5,
        img_12_5,
        img_22_5,
        img_14_5,
        img_16_5,
        img_26_5,
        img_24_5,
        img_29_5,
        img_20_5,
        img_30_5,
        img_11_5,
        img_31_5,
        img_28_5,
        img_32_5,
        img_23_5,
        img_34_5,
        img_27_5,
        img_37_5,
        img_35_5,
        img_36_5,
        img_33_5
      ]
    ],
    // ALL SET

    trialTypes: [
      'prac_test',
      'prac_test',
      'inst2',
      'testbig',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'test',
      'testsmall',
      'test',
      'testbig',
      'test',
      'test',
      'testbig',
      'testbig',
      'test',
      'test',
      'test',
      'testsmall',
      'test',
      'test',
      'testbig'
    ],
    // ALL SET
    // trials will hold all the information for each trial
    trials: []
    // ALL SET
  };

  // additional variables that the experiment needs in order to function
  const vars = {
    // variable that we use to hold the event chain
    ch: null,
    // variable that saves last three correct/incorrect to implement 3-consecutive-incorrects-and-test-stops discontinue rule
    lastthree: [1, 1, 1],
    // whether the user has been reminded about troubleshooting tips
    rtWarned: false
  };

  // show the stimuli
  function showStims(trial) {
    experiment.question.src = trial.question;
    experiment.leftmostStim.src = trial.leftmostStim;
    experiment.leftStim.src = trial.leftStim;
    experiment.rightStim.src = trial.rightStim;
    experiment.rightmostStim.src = trial.rightmostStim;
    experiment.centerStim.src = trial.centerStim;
  }

  // hide the stimuli
  function hideStims() {
    experiment.question.src =
      experiment.leftmostStim.src =
      experiment.leftStim.src =
      experiment.rightStim.src =
      experiment.centerStim.src =
      experiment.rightmostStim.src =
        experiment.blankImg;
  }

  // function that pushes one trial's worth of data on to the results array
  function recordData(input, trial) {
    experiment.results.push({
      correct: input.response == trial.correctResponse ? 1 : 0,
      correctResponse: trial.correctResponse,
      response: input.response,
      rt: input.rt,
      type: trial.type
    });
    // recompute correct/incorrect on last three trials, adding current trial
    vars.lastthree[2] = vars.lastthree[1];
    vars.lastthree[1] = vars.lastthree[0];
    vars.lastthree[0] = input.response == trial.correctResponse ? 1 : 0;
  }

  // processes the user's response, and records the data for the trial if necessary
  function processResponse(input, trial) {
    /* change the response to easy-to-store and compare integers, with 1 corresponding
     * to the left image, 2 to center image, 3 to right image, and 4 to a document
     * click, screen tap, or a memorization trial (requires no input).
     */
    switch (input.response) {
      // case "1stim": etc
      case 'leftmostStim':
        input.response = 1;
        break;
      case 'leftStim':
        input.response = 2;
        break;
      case 'centerStim':
        input.response = 3;
        break;
      case 'rightStim':
        input.response = 4;
        break;
      case 'rightmostStim':
        input.response = 5;
        break;
      case 'question':
        input.response = 0;
        break;
      case 'document':
        input.response = 0;
        break;
      case 'space':
        input.response = 0;
        break;
    }

    // no more input is needed, so stop all listeners
    if (withTouch) {
      disableTouch(config.clickObjs);
      disableTouch('document');
    } else {
      disableKeyboard();
    }
    // hide stimuli
    hideStims();
    // if there's a chain of timeouts, clear them all
    if (vars.ch) clearChain(vars.ch);

    /* if we're in one of the practice states, check user response. If wrong, tell them
     * they're wrong, and let them try again. If correct, tell them so, and let them
     * continue. This trial is not recorded.
     */
    if (trial.type === 'prac_test') {
      $$$('headText').innerHTML = '';
      $$$('trialNum').innerHTML = '';
      if (trial.correctResponse != input.response) {
        $$$('incorrect_text').innerHTML = text.incorrect;
        showSlide('incorrect');
        experiment.trials.splice(0, 0, trial); // add this trial back onto the trials array
        if (!withTouch) getKeyboardInput(['space'], clearTrial, trial);
        else getTouchInput('document', clearTrial, trial);
      } else {
        // record data
        recordData(input, trial);
        $$$('correct_text').innerHTML = text.correct;
        showSlide('correct');
        if (!withTouch) getKeyboardInput(['space'], clearTrial, trial);
        else getTouchInput('document', clearTrial, trial);
      }
      return;
    }

    // record data
    recordData(input, trial);
    // and this trial is done; go to the next trial.
    nextTrial();
  }

  // clears the current trial completely without recording data; useful for warnings and errors
  function clearTrial() {
    // hide stimuli
    hideStims();
    // if there's a chain of timeouts, clear them all
    if (vars.ch) clearChain(vars.ch);
    // no more input is needed, so stop all listeners
    if (withTouch) {
      disableTouch(config.clickObjs);
      disableTouch('document');
    } else {
      disableKeyboard();
    }

    // and this trial is done; go to the next trial.
    nextTrial();
  }

  // The main function to handle running the trials.
  // This contains the chain of events and the end of experiment functionality.
  function nextTrial() {
    let trial;
    // Shift the next trial's information off the front of the trials array.
    if ((trial = experiment.trials.shift()) && vars.lastthree[0] + vars.lastthree[1] + vars.lastthree[2] > 0) {
      // Show instructions, wait for user response
      //edit what's inside the practice. no memory
      if (trial.type === 'inst2') {
        $$$('headText').innerHTML = '';
        $$$('trialNum').innerHTML = '';

        // if touch, force orientation
        if (!withTouch) getKeyboardInput(['space'], processResponse, trial);
        else getTouchInput('document', processResponse, trial);
        showSlide(trial.type);
        // The memorization stage -- show pictures for a certain amount of time and continue
        // The testing stage -- wait for user input, and do not continue until input is given
      } else {
        // Show the correct heading, whether we're in the practice stage or not
        if (trial.type === 'prac_test') {
          $$$('trialNum').innerHTML = '';
          $$$('headText').innerHTML = text.instPrac;
        }

        if (trial.type == 'testbig') {
          $('#question').css('height', '300px');
          $('#question').css('width', 'auto');
        } else if (trial.type == 'testsmall') {
          $('#question').css('height', '100px');
          $('#question').css('width', 'auto');
        } else {
          $('#question').css('height', '200px');
          $('#question').css('width', 'auto');
        }
        // create the chain of timeouts for this testing trial
        vars.ch = chain(
          // show blank first
          function () {
            hideStims();
            showSlide('empty');
          },
          config.ITIDuration,
          // start timing, show pictures, wait for touch or keyboard input
          function () {
            if (trial.type === 'test' || trial.type === 'testbig' || trial.type === 'testsmall')
              $$$('trialNum').innerHTML = trial.num - 3 + text.ofNumTestStims;
            else $$$('trialNum').innerHTML = trial.num + text.ofNumPracTestStims;
            showStims(trial);
            showSlide('stimDiv');

            vars.clickRtStart = new Date();
            if (!withTouch) getKeyboardInput(config.respKeys, processResponse, trial);
            else getTouchInput(config.clickObjs, processResponse, trial);
          },
          config.respDuration,
          /* if we're in the practice trial and user took a long time to
           * respond, show troubleshooting tips.
           */
          function () {
            if (!vars.rtWarned && trial.type === 'prac_test') {
              $$$('headText').innerHTML = '';
              $$$('trialNum').innerHTML = '';
              $$$('warning_text').innerHTML = text.troubleshooting;
              showSlide('warn');
              vars.rtWarned = true;
              experiment.trials.splice(0, 0, trial);
              if (!withTouch) getKeyboardInput(['space'], clearTrial, trial);
              else getTouchInput('document', clearTrial, trial);
            }
          }
        );
      }
    } else {
      $$$('headText').innerHTML = '';
      $$$('trialNum').innerHTML = '';

      // if there are no more trials, generate a score and submit the form with results
      //$$$('data').value = JSON.stringify(experiment.results);

      // calculate the score and submit results
      let score = 0;
      for (let i = 0; i < experiment.results.length; i++) {
        if (
          (experiment.results[i].type === 'test' && experiment.results[i].correct) ||
          (experiment.results[i].type === 'testbig' && experiment.results[i].correct) ||
          (experiment.results[i].type === 'testsmall' && experiment.results[i].correct)
        )
          score++;
      }

      done({
        results: experiment.results,
        score
      });
      //$$$('score').value = score;
      //alert($$$('score').value);
      // $$$('form').submit();
    }
  }

  // setup function
  function setup() {
    // set up instructions
    $$$('inst2text').innerHTML = text.inst2;
    // disable elastic scrolling on touch
    if (withTouch) disableElasticScrolling();

    // grab image elements
    experiment.question = $$$('question');
    experiment.leftmostStim = $$$('leftmostStim');
    experiment.leftStim = $$$('leftStim');
    experiment.centerStim = $$$('centerStim');
    experiment.rightStim = $$$('rightStim');
    experiment.rightmostStim = $$$('rightmostStim');

    // determine keys or objects that could be clicked/tapped for user responses
    //edit the keys possible
    config.respKeys = withTouch
      ? []
      : {
          1: $$$('leftmostStim'),
          2: $$$('leftStim'),
          3: $$$('centerStim'),
          4: $$$('rightStim'),
          5: $$$('rightmostStim'),
          highlight: true
        };
    config.clickObjs = withTouch
      ? [$$$('leftmostStim'), $$$('leftStim'), $$$('centerStim'), $$$('rightStim'), $$$('rightmostStim')]
      : [];

    // populate the trials array
    for (let i = 0; i < experiment.trialTypes.length; i++) {
      experiment.trials.push({
        centerStim: experiment.stims[3][i],
        correctResponse: experiment.correctResponses[i],
        leftStim: experiment.stims[2][i],
        leftmostStim: experiment.stims[1][i],
        num: i + 1,
        question: experiment.stims[0][i],
        rightStim: experiment.stims[4][i],
        rightmostStim: experiment.stims[5][i],
        st: 0,
        type: experiment.trialTypes[i]
      });
    }

    // preload all images
    preload(experiment.preloadArr, nextTrial);
  }

  // begin experiment!
  setup();

  document.getElementById('content')?.addEventListener('click', () => {
    simulateKeyEvent('keydown', 32);
    simulateKeyEvent('keyup', 32);
  });
  document.getElementById('leftmostStim').addEventListener('click', () => {
    simulateKeyEvent('keydown', 49);
    simulateKeyEvent('keyup', 49);
  });
  document.getElementById('leftStim').addEventListener('click', () => {
    simulateKeyEvent('keydown', 50);
    simulateKeyEvent('keyup', 50);
  });
  document.getElementById('centerStim').addEventListener('click', () => {
    simulateKeyEvent('keydown', 51);
    simulateKeyEvent('keyup', 51);
  });
  document.getElementById('rightStim').addEventListener('click', () => {
    simulateKeyEvent('keydown', 52);
    simulateKeyEvent('keyup', 52);
  });
  document.getElementById('rightmostStim').addEventListener('click', () => {
    simulateKeyEvent('keydown', 53);
    simulateKeyEvent('keyup', 53);
  });
}
